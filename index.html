<!DOCTYPE html>
<html lang="zh-tw">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>數學成績查詢系統</title>
	<style>
		body { font-family: Arial, sans-serif; padding: 20px; background-color: #ffe6f0; }
		#result { margin-top: 20px; }
		table { 
			border-collapse: collapse; 
			width: calc(100% - 40px); /* 修改：將表格寬度調整，左右留 20px 空隙 */
			margin: 0 auto 20px auto; /* 修改：置中表格，並在左右留空隙 */
		}
		th {
			border: 1px solid #ccc;
			padding: 4px; /* 修改：由原本的 8px 縮減為 4px */
			background-color: #f2f2f2;
			text-align: center;
		}
		td {
			border: 1px solid #ccc;
			padding: 4px; /* 修改：由原本的 8px 縮減為 4px */
			text-align: left;
		}
		section { 
			margin: 20px 0; /* 修改：去除左右自動邊距，僅保留上下間距 */
			max-width: 500px; 
			border: 1px solid #add8e6;
			background-color: #f0f8ff;
			border-radius: 4px;
		}
		.query-container {
			text-align: center;
			margin-bottom: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 20px; 
		}
		input[type="text"], input[type="password"] {
			border: 1px solid #ccc;
			border-radius: 4px;
			padding: 8px;
			font-size: 16px;
			width: 250px;
		}
		button {
			background-color: #4CAF50;
			color: white;
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			cursor: pointer;
			white-space: nowrap;
		}
		button:hover { background-color: #45a049; }
		h1 { text-align: center; font-size: 36px; }
		h3 { text-align: center; }
		.error-message {
			color: #D8000C;
			background-color: #FFBABA;
			padding: 10px;
			border: 1px solid #D8000C;
			border-radius: 4px;
			text-align: center;
			margin-top: 20px;
			width: 120px; /* 新增：設定寬度為 10% */
			margin: 20px auto; /* 新增：置中並與上方/下方保持間距 */
		}
		.loading-message {
			background-color: #b3d9ff;
			color: #333;
			padding: 20px;
			border: 1px solid #5dade2;
			border-radius: 4px;
			text-align: center;
			animation: fadeInOut 2s linear infinite;
			margin: 30px auto; /* 新增：置中且與邊界保有間距 */
			width: 100px; /* 新增：調整寬度 */
		}
		@keyframes fadeInOut {
			0% { opacity: 0; }
			50% { opacity: 1; }
			100% { opacity: 0; }
		}
		@media (max-width: 600px) {
			body { font-size: 18px; padding: 20px; }
			h1 { font-size: 42px; }
			h3 { font-size: 28px; }
			input[type="text"], input[type="password"] { width: 100%; font-size: 18px; }
			button { font-size: 18px; padding: 12px 20px; }
			table th, table td { padding: 12px; }
			.loading-message { font-size: 18px; padding: 25px; }
		}
	</style>
</head>
<body>
	<h1>數學成績查詢系統</h1>
	<div class="query-container">
		<input type="text" id="query" placeholder="請輸入姓名或學號" />
		<input type="password" id="password" placeholder="請輸入密碼" />
		<button id="searchBtn">查詢</button>
	</div>
	<div id="result">
	</div>
	<script>
		function objectToTable(obj, title) {
			let html = `<section><h3>${title}</h3><table>`;
			if(title !== "個人資料") {
				html += "<tr><th>項目</th><th>成績</th></tr>";
			}
			for(let key in obj) {
				html += `<tr><td>${key}</td><td>${obj[key]}</td></tr>`;
			}
			html += "</table></section>";
			return html;
		}
		function arrayToTable(arr, title) {
			if(arr.length === 0) return "";
			let html = `<section><h3>${title}</h3><table>`;
			// 修改：若標題為 "分項成績" 且只有兩個欄位，則對調欄位順序
			let keys = Object.keys(arr[0]);
			if(title === "分項成績" && keys.length === 2) { 
				keys = [keys[1], keys[0]];
			}
			html += "<tr>";
			keys.forEach(key => { html += `<th>${key}</th>`; });
			html += "</tr>";
			arr.forEach(item => {
				html += "<tr>";
				keys.forEach(key => { html += `<td>${item[key]}</td>`; });
				html += "</tr>";
			});
			html += "</table></section>";
			return html;
		}
		document.getElementById('searchBtn').addEventListener('click', async () => {
			const rawQuery = document.getElementById('query').value.trim();
			const password = document.getElementById('password').value.trim();
			const resultDiv = document.getElementById('result');
			resultDiv.innerHTML = "<div class='loading-message'>載入中...</div>";
			try {
				const res = await fetch("https://cc4pkp9n-80.asse.devtunnels.ms/grade", {
					method: "POST",
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify({ query: rawQuery, password: password })
				});
				const data = await res.json();
				// 新增：檢查返回資料是否包含 error，若有則顯示錯誤訊息
				if (data.error) {
					resultDiv.innerHTML = `<div class="error-message">查詢失敗: ${data.error}</div>`;
					return;
				}
				let html = "";
				// 修改：「個人資料」使用 account 資料
				html += objectToTable(data.account, "個人資料");
				// 修改：「分項成績」使用 grades.details 的數列資料
				if (data.grades.details && data.grades.details.length > 0) {
					html += arrayToTable(data.grades.details, "分項成績");
				} else {
					html += "<section><h3>分項成績</h3>查無分項成績資料</section>";
				}
				if (data.grades.final && Object.keys(data.grades.final).length > 0) {
					html += objectToTable(data.grades.final, "總成績");
				} else {
					html += "<section><h3>總成績</h3>查無總成績資料</section>";
				}
				resultDiv.innerHTML = html;
			} catch (error) {
				resultDiv.innerHTML = `<div class="error-message">查詢失敗: ${error}</div>`;
			}
		});
		document.getElementById('query').addEventListener('keydown', (e) => {
			if (e.key === 'Enter') {
				document.getElementById('searchBtn').click();
			}
		});
	</script>
</body>
</html>